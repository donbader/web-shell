# Development Dockerfile for Web Shell Backend
FROM node:20-alpine

# Build argument for cache busting environment files
ARG ENV_CONFIG_VERSION=1
# Build argument for cache busting source code
ARG SOURCE_VERSION=1

# Install system dependencies for node-gyp and terminal tools
RUN apk add --no-cache \
    python3 make g++ \
    zsh bash \
    git curl \
    && rm -rf /var/cache/apk/*

WORKDIR /app

# Copy package files (cached unless package.json changes)
COPY package*.json ./

# Install ALL dependencies (including dev dependencies for tsx)
RUN npm install

# Copy source code (invalidates cache when SOURCE_VERSION changes)
ARG SOURCE_VERSION
RUN echo "Source version: ${SOURCE_VERSION}"
COPY . .

# Copy shell configurations (invalidates cache when ENV_CONFIG_VERSION changes)
ARG ENV_CONFIG_VERSION
RUN echo "Environment config version: ${ENV_CONFIG_VERSION}"
COPY environments/default/.zshrc /root/.zshrc
COPY environments/default/.bashrc /root/.bashrc

# Expose backend port
EXPOSE 3366

# Start development server with tsx
CMD ["npm", "run", "dev"]
