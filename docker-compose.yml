services:
  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    container_name: web-shell-docker-proxy
    restart: unless-stopped
    privileged: true  # Required to access Docker socket
    environment:
      # Grant minimal permissions needed for web-shell functionality
      CONTAINERS: 1      # Create/manage containers
      EXEC: 1           # Execute commands in containers
      IMAGES: 1         # Pull/manage images
      BUILD: 1          # Build images (required for environment creation)
      VOLUMES: 1        # Create/manage volumes
      NETWORKS: 1       # Network access for containers
      INFO: 1           # Docker info (useful for health checks)

      # Deny dangerous operations
      COMMIT: 0         # Deny container commits
      CONFIGS: 0        # Deny config management
      DISTRIBUTION: 0   # Deny distribution operations
      SECRETS: 0        # Deny secrets access
      SERVICES: 0       # Deny service management
      SWARM: 0          # Deny swarm operations
      SYSTEM: 0         # Deny system operations
      TASKS: 0          # Deny task management

    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Read-only mount
    networks:
      - docker-proxy-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:2375/version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        - ENVIRONMENT=${BACKEND_ENVIRONMENT:-default}
    image: web-shell-backend:${BACKEND_ENVIRONMENT:-default}
    container_name: web-shell-backend
    restart: unless-stopped
    ports:
      - "3366:3366"
      # Uncomment for HTTPâ†’HTTPS redirect in production
      # - "80:80"
    environment:
      - NODE_ENV=production
      - PORT=3366
      - AUTH_ENABLED=${AUTH_ENABLED:-false}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3377}
      - MAX_SESSIONS_PER_USER=${MAX_SESSIONS_PER_USER:-5}
      - IDLE_TIMEOUT_MINUTES=${IDLE_TIMEOUT_MINUTES:-30}
      - DOCKER_HOST=tcp://docker-proxy:2375  # Connect through proxy instead of direct socket
      # Network for session containers (must match docker-compose network with project prefix)
      - DOCKER_NETWORK=web-shell_network
      # HTTPS/SSL Configuration
      - USE_HTTPS=${USE_HTTPS:-false}
      - SSL_KEY_PATH=${SSL_KEY_PATH:-/app/certs/key.pem}
      - SSL_CERT_PATH=${SSL_CERT_PATH:-/app/certs/cert.pem}
      - HTTP_PORT=${HTTP_PORT:-80}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      # Optional: Mount host directory for persistent session data
      - backend-data:/app/data
      # SECURITY: Direct Docker socket mount REMOVED - access now through proxy
      # Mount SSL certificates (production)
      # - /etc/ssl/private:/app/certs:ro
    networks:
      - network
      - docker-proxy-network  # Connect to proxy network
    depends_on:
      docker-proxy:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3366/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:3366}
        - VITE_WS_URL=${VITE_WS_URL:-ws://localhost:3366}
    container_name: web-shell-frontend
    restart: unless-stopped
    ports:
      - "3377:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.25'
          memory: 64M

networks:
  network:
    driver: bridge
  docker-proxy-network:  # Isolated network for Docker proxy access
    driver: bridge
    internal: false  # Proxy needs external access to Docker daemon

volumes:
  backend-data:
    driver: local
